<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body></body>
  <script>
    /*
     * @Author: ChuandongHuang chuandong_huang@human-horizons.com
     * @Date: 2024-01-17 15:45:48
     * @LastEditors: ChuandongHuang chuandong_huang@human-horizons.com
     * @LastEditTime: 2024-01-17 16:56:35
     * @Description:
     */
    let person = {
      age: 18,
      name: "tom",
    };
    class Observer {
      constructor(data) {
        // æ–°å¢ä¸€ä¸ªobå±æ€§ï¼Œè¡¨ç¤ºå·²ç»æ˜¯å“åº”å¼æ•°æ®äº†ï¼Œé¿å…é‡å¤æ“ä½œ
        // def(data, '__ob__', this);
        if (Array.isArray(data)) {
          // å¤„ç†æ•°ç»„é€»è¾‘
        } else {
          this.walk(data);
        }
      }
      walk(data) {
        // è·å–dataä¸­æ‰€æœ‰çš„key
        const keys = Object.keys(data);
        keys.forEach((key) => {
          defineReactive(data, data[key], key);
        });
      }
    }
    function defineReactive(data, val, key) {
      const dep = new Dep(); // æ¯ä¸ªå±æ€§éƒ½æœ‰è‡ªå·±çš„depå®ä¾‹
      // å¦‚æœæ•°æ®ä¸ºobject,éœ€è¦å†æ¬¡è°ƒç”¨
      if (typeof val === "object") {
        new Observer(val);
      }
      Object.defineProperty(data, key, {
        enumerable: true,
        configurable: true,
        get() {
          Dep.target && dep.addSub(Dep.target); // åœ¨getçš„æ—¶å€™ä¾èµ–æ”¶é›†
          console.log("ğŸš€ ~ get ~ val:", val);
          return val;
        },
        set(newVal) {
          if (val === newVal) return;
          console.log("ğŸš€ ~ set ~ newVal:", newVal);
          val = newVal;
          dep.notify(newVal); // setæ—¶é€šçŸ¥æ›´æ–°
        },
      });
    }
    // ä¾èµ–ç®¡ç†å™¨
    class Dep {
      constructor() {
        this.subs = [];
      }
      // æ·»åŠ ä¾èµ–
      addSub(sub) {
        this.subs.push(sub);
      }
      // é€šçŸ¥ä¾èµ–æ›´æ–°
      notify() {
        const subs = this.subs.slice();
        for (let i = 0; i < subs.length; i++) {
          this.subs[i].cb();
        }
      }
    }
    // ä¾èµ–
    class Watcher {
      constructor(vm, exp, cb) {
        this.vm = vm; // vueå®ä¾‹
        this.exp = exp; // key
        this.cb = cb; // æ•°æ®å˜åŒ–æ‰§è¡Œçš„å›è°ƒ
        this.value = this.get();
      }
      //  è·å–æ•°æ®ï¼ŒåŒæ—¶æŠŠå½“å‰Watcherå®ä¾‹è®¾ç½®ä¸ºDep.targetï¼Œè¿›è¡Œä¾èµ–æ”¶é›†
      get() {
        Dep.target = this; // å°†å½“å‰ Watcher å®ä¾‹è®¾ç½®ä¸ºå…¨å±€çš„ Dep.target
        const value = this.vm._data[this.exp]; // è§¦å‘getterï¼Œå®ç°ä¾èµ–æ”¶é›†
        Dep.target = null; // é‡ç½®Dep.targe é¿å…å½±å“å…¶ä»–ä¾èµ–æ”¶é›†
        return value;
      }
      //  æ›´æ–°æ–¹æ³•ï¼Œæ•°æ®å˜åŒ–æ—¶è°ƒç”¨
      update() {
        this.cb();
      }
    }
    new Observer(person);
    const vm = { _data: person };
    const watcher = new Watcher(vm, "age", () => {
      console.log("ğŸš€ ~ watcher ~ å‡½æ•°å›è°ƒ:");
    });
    person.age = 20;
  </script>
</html>
